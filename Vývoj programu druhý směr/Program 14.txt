*&---------------------------------------------------------------------*
*& Report ZPP_API_MATRIX_MAINT
*&---------------------------------------------------------------------*
*&
*&---------------------------------------------------------------------*
REPORT zpp_api_matrix_maint_tmp.

* üìå TABLE: ZPP_API_MATRIX
* üìå Structure: ZPP_API_MATRIX_STR

DATA:
  sap_id TYPE matnr,        " Hotov√Ω v√Ωrobek(l√©ƒçivo) üè∑Ô∏è
  werks  TYPE werks_d,      " K√≥d z√°vodu üè≠
  api_id TYPE idnrk,        " Identifik√°tor API (BOM = kusovn√≠k, mus√≠ b√Ωt MTART = VPOL) üîë
  charg  TYPE charg_d,      " ≈†ar≈æe materi√°lu üß™
  datuv  TYPE dats,         " Datum platnosti certifik√°tu üìÖ
  datub  TYPE dats.         " Datum ukonƒçen√≠ platnosti ceritifik√°tu üìÖ


DATA  gs_variant   TYPE          disvariant.

SELECTION-SCREEN BEGIN OF BLOCK b1 WITH FRAME TITLE TEXT-011.
  SELECTION-SCREEN BEGIN OF BLOCK b2 WITH FRAME TITLE TEXT-012.
    SELECT-OPTIONS: s_sap_id FOR sap_id NO INTERVALS,
                    s_werks  FOR werks  NO INTERVALS,
                    s_api_id FOR api_id NO INTERVALS,
                    s_charg  FOR charg  NO INTERVALS,
                    s_datuv  FOR datuv  NO INTERVALS,
                    s_datub  FOR datub  NO INTERVALS.
  SELECTION-SCREEN END OF BLOCK b2.

  SELECTION-SCREEN BEGIN OF BLOCK b3 WITH FRAME TITLE TEXT-010.
    PARAMETERS: r_all   RADIOBUTTON GROUP rb1,
                r_val   RADIOBUTTON GROUP rb1,
                r_inval RADIOBUTTON GROUP rb1.
  SELECTION-SCREEN END OF BLOCK b3.
SELECTION-SCREEN END OF BLOCK b1.

* üìå  layout selection
SELECTION-SCREEN BEGIN OF BLOCK b05 WITH FRAME TITLE TEXT-013.
  PARAMETERS: p_varnt LIKE disvariant-variant.
SELECTION-SCREEN END OF BLOCK b05.

TYPES: BEGIN OF ty_zpp_api_matrix_str,
         sap_id           TYPE matnr,            " Hotov√Ω v√Ωrobek(l√©ƒçivo) üè∑Ô∏è
         werks            TYPE werks_d,          " K√≥d z√°vodu üè≠
         maktx            TYPE maktx,            " Popis materi√°lu üìù
         destination      TYPE char2,            " Destinace üåç
         inn_device       TYPE char40,           " N√°zev l√©ƒçiv√© l√°tky üñ•Ô∏è
         mzp              TYPE numc2,            " K√≥d MZP (mno≈æstv√≠) üî¢
         charg            TYPE charg_d,          " ≈†ar≈æe materi√°lu üß™
         production_plant TYPE char4,            " K√≥d v√Ωrobn√≠ho z√°vodu üè≠
         mzp_csp          TYPE numc2,            " K√≥d CSP (Cenov√° specifikace) üí≤
         api_id           TYPE matnr,            " BOM(kusovn√≠k) üÜî
         api_name         TYPE maktx,            " Kr√°tk√Ω text kusovn√≠ku üìã
         mzp_bc           TYPE char40,           " K√≥d pro BC (Business Case) üìä
         datuv            TYPE dats,             " Datum poƒç√°tƒçn√≠ platnosti certifik√°tu üìÖ
         datuv_old        TYPE dats,             " Star√© datum platnosti certifik√°tu üìÖ
         datub            TYPE dats,             " Datum fin√°ln√≠ platnosti certifik√°tu üìÖ
         datub_old        TYPE dats,             " P≈ôedchoz√≠ fin√°ln√≠ platnost certifik√°tu üìÖ

         verify           TYPE char4,            " STATUS, zda certifik√°t je platn√Ω üîç
         cellstyles       TYPE lvc_t_styl,       " Stylov√°n√≠ bunƒõk pro ALV(Editace pol√≠) üñçÔ∏è
       END OF ty_zpp_api_matrix_str.

CLASS lcl_app DEFINITION.
  PUBLIC SECTION.
* üìå  P≈ôidat konstanty a ve≈ôejn√° data

    METHODS:
      run,         " üöÄ

      read,        " üï∂Ô∏è
      add_row,     " üöÄ
      insert_row,  " ‚úÖ
      update,      " ‚úÖ
      delete,      " ‚ùå
      display,     " üí°
      alv_create,  " ‚úÖ
      alv_refresh, " üîÑ
      alv_edit,    " ‚úèÔ∏è
      alv_edit_after_delete, " ‚úèÔ∏è‚ùå

      handle_toolbar FOR EVENT toolbar OF cl_gui_alv_grid
        IMPORTING e_object e_interactive,

      handle_user_command FOR EVENT user_command OF cl_gui_alv_grid
        IMPORTING e_ucomm,

      handle_data_changed FOR EVENT data_changed OF cl_gui_alv_grid
        IMPORTING er_data_changed e_onf4 e_onf4_before e_onf4_after e_ucomm.

  PRIVATE SECTION.

    DATA:
      " Referenƒçn√≠ promƒõnn√© pro ALV Grid a Custom Container üñ•Ô∏è
      mo_grid             TYPE REF TO cl_gui_alv_grid,                " ALV Grid pro zobrazen√≠ dat v tabulce üìä
      mo_custom_container TYPE REF TO cl_gui_custom_container,        " Custom Container pro p≈ôizp≈Øsoben√≠ vzhledu üß∞

      " Tabulky pro data z matrixu zpp_api_matrix üìù
      mt_data             TYPE TABLE OF ty_zpp_api_matrix_str,        " Hlavn√≠ data pro z√°znamy tabulky zpp_api_matrix_strüìã
      mt_data_change      TYPE TABLE OF ty_zpp_api_matrix_str.        " Zmƒõnƒõn√° data pro logov√°n√≠ zmƒõn üîÑ


ENDCLASS.                          "lcl_app DEFINITION

CLASS lcl_app IMPLEMENTATION.
  METHOD run.

    IF p_varnt IS NOT INITIAL.
      gs_variant-variant = p_varnt.
    ENDIF.

    read( ).
    alv_edit( ).
    display( ).
  ENDMETHOD.

  METHOD read.  " üï∂Ô∏è

    DATA:
      " Tabulka pro z√°znamy z tabulky zpp_api_matrix üñ•Ô∏è
      lt_zpp_api_matrix TYPE TABLE OF zpp_api_matrix,

      " Tabulka pro data z ty_zpp_api_matrix_str üìÑ
      lt_data           TYPE TABLE OF ty_zpp_api_matrix_str,

      " Tabulky pro Makt üìë
      lt_makt_matnr     TYPE TABLE OF makt,  " Tabulka materi√°lov√Ωch ƒç√≠sel üè∑Ô∏è
      lt_makt_idnrk     TYPE TABLE OF makt.  " Tabulka ID ƒç√≠sel üì†

    " Data pro parametry üìä
    DATA:
      lv_parts_value_1 TYPE i,  " Hodnota pro prvn√≠ parametr üî¢
      lv_parts_value_2 TYPE i.  " Hodnota pro druh√Ω parametr üî¢


    lv_parts_value_1 = 1.
    lv_parts_value_2 = 2.

    SELECT *
      FROM zpp_api_matrix
      INTO TABLE @lt_zpp_api_matrix
        WHERE sap_id = @s_sap_id-low
        AND   werks  = @s_werks-low.

    IF lt_zpp_api_matrix[] IS INITIAL.
      SELECT *
      FROM zpp_api_matrix
      INTO TABLE @lt_zpp_api_matrix.
    ENDIF.

*‚úÖ naplnƒõn√≠ daty tabulku struktury lt_data
    lt_data = CORRESPONDING #( lt_zpp_api_matrix ). "üí° P≈ôesun v≈°ech ≈ô√°dk≈Ø

*‚úÖ Naplnƒõn√≠ tabulky s kr√°tk√Ωm textem materi√°lu
    SELECT * FROM makt
     INTO CORRESPONDING FIELDS OF TABLE lt_makt_matnr
     FOR ALL ENTRIES IN lt_zpp_api_matrix
     WHERE matnr = lt_zpp_api_matrix-sap_id.

*‚úÖ Naplnƒõn√≠ tabulky s kr√°tk√Ωm textem komponenty
    SELECT * FROM makt
     INTO CORRESPONDING FIELDS OF TABLE lt_makt_idnrk
     FOR ALL ENTRIES IN lt_zpp_api_matrix
     WHERE matnr = lt_zpp_api_matrix-api_id.

* ‚úèÔ∏è naƒç√≠st maktx pro Hotov√Ω v√Ωrovek
    LOOP AT lt_data INTO DATA(ls_data). "

      DATA(ls_makt_matnr) = VALUE #( lt_makt_matnr[ matnr = ls_data-sap_id
                                                    spras = sy-langu ] OPTIONAL ).

      IF ls_makt_matnr IS INITIAL.
        ls_makt_matnr = VALUE #( lt_makt_matnr[ matnr = ls_data-sap_id ] OPTIONAL ).
      ENDIF.

      ls_data-maktx = COND #( WHEN ls_makt_matnr IS NOT INITIAL
                               THEN ls_makt_matnr-maktx
                               ELSE space ).

*‚úèÔ∏è Doplnƒõn√≠ destinace pomoc√≠ splitu a readu
      IF ls_data-maktx IS NOT INITIAL.
        DATA(lv_string) = ls_data-maktx.
        SPLIT lv_string AT '(' INTO TABLE DATA(lt_parts).

        DATA(lv_substring) = lt_parts[ lv_parts_value_2 ].

        SPLIT lv_substring AT ')' INTO TABLE lt_parts.
        lv_substring = lt_parts[ lv_parts_value_1 ].

        ls_data-destination = lv_substring.
      ENDIF.

*‚úèÔ∏è naƒç√≠st maktx pro komponentu komponenty API_NAME
      DATA(ls_makt_idnrk) = VALUE #( lt_makt_idnrk[ matnr = ls_data-api_id
                                                    spras = sy-langu ] OPTIONAL ).

      IF ls_makt_idnrk IS INITIAL.
        ls_makt_idnrk = VALUE #( lt_makt_idnrk[ matnr = ls_data-api_id ] OPTIONAL ).
      ENDIF.

      ls_data-api_name = COND #( WHEN ls_makt_idnrk IS NOT INITIAL
                                 THEN ls_makt_idnrk-maktx
                                 ELSE space ).

*‚úèÔ∏è Zji≈°en√≠ platnosti certifik√°tu
      ls_data-verify = COND #( WHEN ls_data-datub >= sy-datum
                                 AND ls_data-datuv <= sy-datum
                                 AND ls_data-datub > ls_data-datuv
                                 AND ls_data-datuv IS NOT INITIAL
                               THEN icon_green_light
                               ELSE icon_red_light ).


*‚úèÔ∏è Filtrace v√Ωsledk≈Ø podle platnosti
      IF r_all = 'X'.
        APPEND ls_data TO mt_data.
      ELSEIF r_val = 'X' AND ls_data-verify = icon_green_light.
        APPEND ls_data TO mt_data.
      ELSEIF r_inval = 'X' AND ls_data-verify = icon_red_light.
        APPEND ls_data TO mt_data.
      ENDIF.
    ENDLOOP.
  ENDMETHOD.

  METHOD add_row.
    " Definice struktur pro data a pr√°zdn√© ≈ô√°dky üìä
    DATA:
      ls_data      TYPE ty_zpp_api_matrix_str, " Struktura pro data üìù
      ls_empty_row TYPE ty_zpp_api_matrix_str. " Struktura pro pr√°zdn√Ω ≈ô√°dek ‚¨õ

    CLEAR ls_empty_row.

*‚úèÔ∏è P≈ôid√°n√≠ pr√°zdn√©ho ≈ô√°dku
    APPEND ls_empty_row TO mt_data.

  ENDMETHOD.

  METHOD insert_row.

    DATA:
      " Tabulky pro Makt üìë
      lt_makt_matnr     TYPE TABLE OF makt,  " Tabulka materi√°lov√Ωch ƒç√≠sel üè∑Ô∏è
      lt_makt_idnrk     TYPE TABLE OF makt,  " Tabulka ID ƒç√≠sel üì†

      " Tabulka pro vybran√© ≈ô√°dky a promƒõnn√© pro poƒçet ≈ô√°dk≈Ø üìä
      lt_selected_rows  TYPE lvc_t_row,     " Tabulka vybran√Ωch ≈ô√°dk≈Ø üìë
      lv_selected_rows  TYPE i,              " Poƒçet vybran√Ωch ≈ô√°dk≈Ø üßÆ

      " Promƒõnn√© pro matkl a dal≈°√≠ hodnoty üõ†Ô∏è
      lv_mtart          TYPE matkl,          " K√≥d materi√°lov√© kategorie üì¶
      lv_parts_value_1  TYPE i,              " Hodnota pro prvn√≠ parametr üî¢
      lv_parts_value_2  TYPE i,              " Hodnota pro druh√Ω parametr üî¢

      " Data pro log tabulku üìù
      ls_data_log       TYPE zpp_api_matrix_l,  " Logov√° struktura üóÇÔ∏è

      " Tabulka a struktura pro z√°znamy z tabulky zpp_api_matrix üìÑ
      lt_zpp_api_matrix TYPE TABLE OF zpp_api_matrix,  " Tabulka z√°znam≈Ø z matrixu üñ•Ô∏è
      ls_data           TYPE zpp_api_matrix.           " Struktura pro jeden z√°znam üìÉ

    " Konstanta pro vlo≈æen√≠ dat üíæ
    CONSTANTS         lc_log_insert TYPE char40 VALUE 'INSERT_DATA'.

    SELECT *
FROM zpp_api_matrix
INTO TABLE lt_zpp_api_matrix.

    SELECT *
      FROM makt
      INTO TABLE lt_makt_matnr
      FOR ALL ENTRIES IN mt_data
      WHERE matnr = mt_data-sap_id.

    SELECT *
       FROM makt
      INTO TABLE lt_makt_idnrk
      FOR ALL ENTRIES IN mt_data
      WHERE matnr = mt_data-api_id.

    CLEAR lt_selected_rows.

    CALL METHOD mo_grid->get_selected_rows
      IMPORTING
        et_index_rows = lt_selected_rows.

    LOOP AT mt_data REFERENCE INTO DATA(lr_data).
      CLEAR lv_selected_rows.
      IF lt_selected_rows[] IS NOT INITIAL.
        lv_selected_rows = VALUE #( lt_selected_rows[ index = sy-tabix ] OPTIONAL ).
        CHECK sy-subrc = 0.
      ENDIF.

      IF lv_selected_rows <> 0 .

        IF  lr_data->sap_id IS NOT INITIAL AND lr_data->werks IS NOT INITIAL
AND lr_data->api_id IS NOT INITIAL AND lr_data->charg IS NOT INITIAL.

*üìé Mus√≠ se prov√©st filtrace jen tƒõch dat, kter√© jsou VPOL. V testovac√≠ch p≈ô√≠padƒõch to bude FERT, pozdƒõji zalo≈æ√≠m v√≠ce p≈ô√≠pad≈Ø üîé üîë

          lv_mtart = 'HALB'.   "‚ùó Zmƒõnit na VPOL u z√°kazn√≠ka

          IF sy-subrc = 0.
            SELECT SINGLE *
              FROM mara
              INTO @DATA(lv_mara)
              WHERE matnr = @lr_data->api_id
              AND   mtart = @lv_mtart.         " ‚ùó Zmƒõnit na VPOL u z√°kazn√≠ka

            IF sy-subrc = 0.
              CLEAR ls_data.
              ls_data-sap_id = lr_data->sap_id. " Materi√°l
              ls_data-werks  = lr_data->werks.  " Z√°vod
              ls_data-api_id = lr_data->api_id. " Komponenta kusovn√≠ku
              ls_data-charg  = lr_data->charg.  " ƒå√≠slo ≈°ar≈æe
              ls_data-datuv  = lr_data->datuv.  " Datum vytvo≈ôen√≠
              ls_data-datub  = lr_data->datub.  " Datum uz√°vƒõrky

              " Vlo≈æen√≠ nov√©ho ≈ô√°dku do ZPP_API_MATRIX
              INSERT INTO zpp_api_matrix VALUES ls_data.

              IF sy-subrc = 0.    " Message, kdy≈æ bude bez chyby

                MESSAGE |Oznaƒçen√© ≈ô√°dky byly √∫spƒõ≈°nƒõ p≈ôid√°ny.| TYPE 'S'.

*‚úèÔ∏è Pokud nem√° mt_data kr√°tk√Ω text materi√°lu k SAP_ID
                DATA(ls_makt_matnr) = VALUE #( lt_makt_matnr[ matnr = lr_data->sap_id spras = sy-langu ] OPTIONAL ).

                IF ls_makt_matnr IS INITIAL.
                  ls_makt_matnr = VALUE #( lt_makt_matnr[ matnr = lr_data->sap_id  ] OPTIONAL ).
                ENDIF.

                lr_data->maktx = COND #( WHEN ls_makt_matnr IS NOT INITIAL
                                         THEN ls_makt_matnr-maktx
                                         ELSE space ).

*‚úèÔ∏è Pokud nem√° mt_data kr√°tk√Ω text materi√°lu k API_ID
                DATA(ls_makt_idnrk) = VALUE #( lt_makt_idnrk[  matnr = lr_data->api_id spras = sy-langu ] OPTIONAL ).

                IF ls_makt_idnrk IS INITIAL.
                  ls_makt_idnrk = VALUE  #( lt_makt_idnrk[ matnr = lr_data->api_id ] OPTIONAL ).
                ENDIF.

                lr_data->api_name = COND #( WHEN ls_makt_idnrk IS NOT INITIAL
                                         THEN ls_makt_idnrk-maktx
                                         ELSE space ).

*‚úèÔ∏è Doplnƒõn√≠ destinace pomoc√≠ splitu a readu
                IF lr_data->maktx IS NOT INITIAL.

                  lv_parts_value_1 = 1.
                  lv_parts_value_2 = 2.

                  DATA(lv_string) = lr_data->maktx.
                  SPLIT lv_string AT '(' INTO TABLE DATA(lt_parts).

                  DATA(lv_substring) = lt_parts[ lv_parts_value_2 ].

                  SPLIT lv_substring AT ')' INTO TABLE lt_parts.
                  lv_substring = lt_parts[ lv_parts_value_1 ].

                  lr_data->destination = lv_substring.
                ENDIF.

                " Naplnƒõn√≠ struktury pro ZPP_API_MATRIX_L
                ls_data_log = VALUE #( sap_id      = lr_data->sap_id
                                       werks       = lr_data->werks
                                       api_id      = lr_data->api_id
                                       charg       = lr_data->charg
                                       datuv       = lr_data->datuv
                                       datuv_old   = VALUE #( lt_zpp_api_matrix[ sap_id  = lr_data->sap_id
                                                                               werks     = lr_data->werks
                                                                               api_id    = lr_data->api_id
                                                                               charg     = lr_data->charg ]-datuv OPTIONAL )
                                       datub       = lr_data->datub
                                       datub_old   = VALUE #( lt_zpp_api_matrix[ sap_id  = lr_data->sap_id
                                                                               werks     = lr_data->werks
                                                                               api_id    = lr_data->api_id
                                                                               charg     = lr_data->charg ]-datub OPTIONAL )
                                       ernam       = sy-uname
                                       change      = lc_log_insert
                                       change_date = sy-datum
                                       change_time = sy-uzeit ).


                " Vlo≈æen√≠ dat do logov√© tabulky
                INSERT INTO zpp_api_matrix_l VALUES ls_data_log.

              ELSE. " Doplnit message, kdy≈æ bude ≈°patn√© vlo≈æen√≠
                MESSAGE |≈ò√°dek ƒç√≠slo { sy-tabix } nemohl b√Ωt p≈ôid√°n. Z√°znam ji≈æ v datab√°zi je obsa≈æen.|  TYPE 'I'.
              ENDIF.

            ELSE.
              MESSAGE |≈ò√°dek ƒç√≠slo { sy-tabix } obsahuje SAP_ID { lr_data->sap_id }, kter√Ω nem√° druh materi√°lu VPOL.|  TYPE 'I'.
            ENDIF.
          ENDIF.
        ELSE.
          MESSAGE |≈ò√°dek ƒç√≠slo { sy-tabix } nemohl b√Ωt p≈ôid√°n. Kl√≠ƒçov√° pole nejsou vyplnƒõna.|  TYPE 'I'.
        ENDIF.
      ENDIF.
    ENDLOOP.

  ENDMETHOD.

  METHOD update.

    DATA:
      " Tabulka pro vybran√© ≈ô√°dky v ALV gridu üìä
      lt_selected_rows  TYPE lvc_t_row,

      " Poƒçet vybran√Ωch ≈ô√°dk≈Ø üî¢
      lv_selected_rows  TYPE i,

      " Tabulka pro z√°znamy z tabulky zpp_api_matrix üìã
      lt_zpp_api_matrix TYPE TABLE OF zpp_api_matrix,

      " Jednotliv√Ω z√°znam z tabulky zpp_api_matrix üíº
      ls_data           TYPE ty_zpp_api_matrix_str,

      " Tabulka pro zmƒõny v datech üìù
      lt_changes        TYPE zpp_api_matrix,

      " Logov√° tabulka pro sledov√°n√≠ zmƒõn v datech üìà
      ls_data_log       TYPE zpp_api_matrix_l.

    " Konstantn√≠ hodnota pro logov√°n√≠ aktualizac√≠ üóÇÔ∏è
    CONSTANTS         lc_log_update TYPE char40 VALUE 'UPDATE_DATA'.  " K√≥d pro logov√°n√≠ aktualizace üîÑ

    SELECT *
    FROM zpp_api_matrix
   INTO TABLE lt_zpp_api_matrix.

    CLEAR lt_selected_rows.

    CALL METHOD mo_grid->get_selected_rows
      IMPORTING
        et_index_rows = lt_selected_rows.

    LOOP AT mt_data REFERENCE INTO DATA(lr_data).
      CLEAR lv_selected_rows.
      IF lt_selected_rows[] IS NOT INITIAL.
        lv_selected_rows = VALUE #( lt_selected_rows[ index = sy-tabix ] OPTIONAL ).
        CHECK sy-subrc = 0.
      ENDIF.

      IF lv_selected_rows <> 0.
        UPDATE zpp_api_matrix
    SET datuv = @lr_data->datuv,
        datub = @lr_data->datub
    WHERE sap_id = @lr_data->sap_id
      AND werks  = @lr_data->werks
      AND api_id = @lr_data->api_id
      AND charg  = @lr_data->charg.

        IF sy-subrc = 0.
          MESSAGE |Datum bylo pozmƒõnƒõno a vlo≈æeno do datab√°ze.|  TYPE 'S'.

          " Naplnƒõn√≠ struktury pro ZPP_API_MATRIX_L
          ls_data_log = VALUE #( sap_id      = lr_data->sap_id
                                 werks       = lr_data->werks
                                 api_id      = lr_data->api_id
                                 charg       = lr_data->charg
                                 datuv       = lr_data->datuv
                                 datuv_old   = VALUE #( lt_zpp_api_matrix[ sap_id  = lr_data->sap_id
                                                                         werks     = lr_data->werks
                                                                         api_id    = lr_data->api_id
                                                                         charg     = lr_data->charg ]-datuv OPTIONAL )
                                 datub       = lr_data->datub
                                 datub_old   = VALUE #( lt_zpp_api_matrix[ sap_id  = lr_data->sap_id
                                                                         werks     = lr_data->werks
                                                                         api_id    = lr_data->api_id
                                                                         charg     = lr_data->charg ]-datub OPTIONAL )
                                 ernam       = sy-uname
                                 change      = lc_log_update
                                 change_date = sy-datum
                                 change_time = sy-uzeit ).

          " Vlo≈æen√≠ dat do logov√© tabulky
          INSERT INTO zpp_api_matrix_l VALUES ls_data_log.
        ELSE.
          MESSAGE |≈ò√°dek ƒç√≠slo { sy-tabix } nemohl b√Ωt pozmƒõnƒõn.|  TYPE 'I'.
        ENDIF.
      ENDIF.
    ENDLOOP.
  ENDMETHOD.

  METHOD delete.

    DATA:
      " Tabulka pro vybran√© ≈ô√°dky v ALV gridu üìä
      lt_selected_rows  TYPE lvc_t_row,

      " Poƒçet vybran√Ωch ≈ô√°dk≈Ø üî¢
      lv_selected_rows  TYPE i,

      " Logov√° tabulka pro sledov√°n√≠ zmƒõn v datech üìà
      ls_data_log       TYPE zpp_api_matrix_l,

      " Tabulka pro z√°znamy z tabulky zpp_api_matrix üíº
      lt_zpp_api_matrix TYPE TABLE OF zpp_api_matrix.


    CONSTANTS lc_log_delete TYPE char40 VALUE 'DELETE_DATA'.

    CLEAR lt_selected_rows.

    SELECT *
FROM zpp_api_matrix
INTO TABLE lt_zpp_api_matrix.

    CALL METHOD mo_grid->get_selected_rows
      IMPORTING
        et_index_rows = lt_selected_rows.


    LOOP AT mt_data REFERENCE INTO DATA(lr_data).
      CLEAR lv_selected_rows.

      IF lt_selected_rows[] IS NOT INITIAL.
        lv_selected_rows = VALUE #( lt_selected_rows[ index = sy-tabix ] OPTIONAL ).
        CHECK sy-subrc = 0.
      ENDIF.

      IF lv_selected_rows <> 0.

        " Vymaz√°n√≠ dat z datab√°zov√© tabulky
        DELETE FROM zpp_api_matrix
         WHERE sap_id = @lr_data->sap_id
           AND werks  = @lr_data->werks
           AND api_id = @lr_data->api_id
           AND charg  = @lr_data->charg.

        IF sy-subrc = 0.
          MESSAGE |≈ò√°dek byl √∫spƒõ≈°nƒõ smaz√°n.|  TYPE 'S'.

          " Naplnƒõn√≠ struktury pro ZPP_API_MATRIX_L
          ls_data_log = VALUE #( sap_id      = lr_data->sap_id
                                 werks       = lr_data->werks
                                 api_id      = lr_data->api_id
                                 charg       = lr_data->charg
                                 datuv       = lr_data->datuv
                                 datuv_old   = VALUE #( lt_zpp_api_matrix[ sap_id  = lr_data->sap_id
                                                                         werks     = lr_data->werks
                                                                         api_id    = lr_data->api_id
                                                                         charg     = lr_data->charg ]-datuv OPTIONAL )
                                 datub       = lr_data->datub
                                 datub_old   = VALUE #( lt_zpp_api_matrix[ sap_id  = lr_data->sap_id
                                                                         werks     = lr_data->werks
                                                                         api_id    = lr_data->api_id
                                                                         charg     = lr_data->charg ]-datub OPTIONAL )
                                 ernam       = sy-uname
                                 change      = lc_log_delete
                                 change_date = sy-datum
                                 change_time = sy-uzeit ).


          " Vlo≈æen√≠ dat do logov√© tabulky
          INSERT INTO zpp_api_matrix_l VALUES ls_data_log.

        ELSE.
          MESSAGE |≈ò√°dek ƒç√≠slo { sy-tabix } nemohl b√Ωt smaz√°n.|  TYPE 'I'.
        ENDIF.

      ENDIF.
    ENDLOOP.

    alv_edit_after_delete( ).

  ENDMETHOD.

  METHOD display.
    CALL SCREEN 0100.
  ENDMETHOD.

  METHOD alv_create.

    DATA: lt_fcat     TYPE        lvc_t_fcat,
          ls_fcat     TYPE        lvc_s_fcat,
          ls_layout   TYPE        lvc_s_layo,
          lr_fieldcat TYPE REF TO lvc_s_fcat,
          ls_exclude  TYPE        ui_func,
          gt_exclude  TYPE        ui_functions.

    DATA: lt_sort TYPE lvc_t_sort,  " Tabulka t≈ô√≠dƒõn√≠
          ls_sort TYPE lvc_s_sort.  " Polo≈æka t≈ô√≠dƒõn√≠

    " üìå Vytvo≈ôen√≠ kontejneru s n√°zvem ALV_GRID
    IF mo_custom_container IS INITIAL.
      CREATE OBJECT mo_custom_container
        EXPORTING
          container_name = 'ALV_GRID'.
      CREATE OBJECT mo_grid
        EXPORTING
          i_parent = mo_custom_container.

      " üìå Zalo≈æen√≠ fieldcatalogu pro zobrazen√≠ ALV
      CALL FUNCTION 'LVC_FIELDCATALOG_MERGE'
        EXPORTING
          i_structure_name       = 'ZPP_API_MATRIX_STR'   " Struktura pro ALV
        CHANGING
          ct_fieldcat            = lt_fcat
        EXCEPTIONS
          inconsistent_interface = 1
          program_error          = 2
          OTHERS                 = 3.

      LOOP AT lt_fcat REFERENCE INTO lr_fieldcat.

        "  üìå Umo≈ænit editaci pro DATUV a DATUB a p≈ôejmenov√°n√≠ sloupc≈Ø.
        CASE lr_fieldcat->fieldname.
          WHEN 'SAP_ID'.

            lr_fieldcat->coltext = 'SAP_ID'.            " Zmƒõna n√°zvu sloupce SAP_ID
            lr_fieldcat->key = 'X'.
          WHEN 'WERKS'.
            lr_fieldcat->coltext = 'Z√°vod'.             " Zmƒõna n√°zvu sloupce WERKS
            lr_fieldcat->key = 'X'.
          WHEN 'MAKTX'.
            lr_fieldcat->coltext = 'N√°zev'.             " Zmƒõna n√°zvu sloupce MAKTX
          WHEN 'DESTINATION'.
            lr_fieldcat->coltext = 'Destinace'.         " Zmƒõna n√°zvu sloupce DESTINATION
          WHEN 'INN_DEVICE'.
            lr_fieldcat->coltext = 'IN za≈ôazen√≠'.       " Zmƒõna n√°zvu sloupce INN_DEVICE
          WHEN 'MZP'.
            lr_fieldcat->coltext = 'MZP'.               " Zmƒõna n√°zvu sloupce MZP
          WHEN 'CHARG'.
            lr_fieldcat->coltext = 'Velikost ≈°ar≈æe'.    " Zmƒõna n√°zvu sloupce CHARG
            lr_fieldcat->key = 'X'.
*            lr_fieldcat->edit = 'X'.
          WHEN 'PRODUCTION_PLANT'.
            lr_fieldcat->coltext = 'M√≠sto v√Ωrovy'.      " Zmƒõna n√°zvu sloupce PRODUCTION_PLANT
          WHEN 'MZP_CSP'.
            lr_fieldcat->coltext = 'MZP ƒåSP'.           " Zmƒõna n√°zvu sloupce MZP_CSP
          WHEN 'API_ID'.
            lr_fieldcat->coltext = 'API ID'.            " Zmƒõna n√°zvu sloupce API_ID
            lr_fieldcat->key = 'X'.
*            lr_fieldcat->edit = 'X'.
          WHEN 'API_NAME'.
            lr_fieldcat->coltext = 'API n√°zev'.         " Zmƒõna n√°zvu sloupce API_NAME
          WHEN 'MZP_BC'.
            lr_fieldcat->coltext = 'MZP BC'.            " Zmƒõna n√°zvu sloupce MZP_BC
          WHEN 'DATUV'.
            lr_fieldcat->coltext = 'Platnost od'.       " Zmƒõna n√°zvu sloupce DATUV
            lr_fieldcat->edit = 'X'.
            lr_fieldcat->key = 'X'.
          WHEN 'DATUV_OLD'.
            lr_fieldcat->coltext = 'Platnost od(OLD)'.  " Zmƒõna n√°zvu sloupce DATUV_OLD
            lr_fieldcat->edit = 'X'.
            lr_fieldcat->key = 'X'.
            lr_fieldcat->tech = 'X'.
          WHEN 'DATUB'.
            lr_fieldcat->coltext = 'Platnost do'.       " Zmƒõna n√°zvu sloupce DATUB
            lr_fieldcat->edit = 'X'.
            lr_fieldcat->key = 'X'.
          WHEN 'DATUB_OLD'.
            lr_fieldcat->coltext = 'Platnost do(OLD)'.       " Zmƒõna n√°zvu sloupce DATUB
            lr_fieldcat->edit = 'X'.
            lr_fieldcat->key = 'X'.
            lr_fieldcat->tech = 'X'.
          WHEN 'GRIS_RELEVATION'.
            lr_fieldcat->coltext = 'GRIS relevance'.    " Zmƒõna n√°zvu sloupce GRIS_RELEVATION
          WHEN 'VERIFY'.
            lr_fieldcat->coltext = 'Platnost'.          " Zmƒõna n√°zvu sloupce VERIFY
        ENDCASE.
      ENDLOOP.

      DELETE lt_fcat WHERE fieldname IS INITIAL.
      ls_exclude = cl_gui_alv_grid=>mc_fc_views.
      APPEND ls_exclude TO gt_exclude.
      ls_exclude = cl_gui_alv_grid=>mc_fc_info.
      APPEND ls_exclude TO gt_exclude.
      ls_exclude = cl_gui_alv_grid=>mc_fc_graph.
      APPEND ls_exclude TO gt_exclude.
      ls_exclude = cl_gui_alv_grid=>mc_fc_print.
      APPEND ls_exclude TO gt_exclude.
      ls_exclude = cl_gui_alv_grid=>mc_fc_check.
      APPEND ls_exclude TO gt_exclude.
      ls_exclude = cl_gui_alv_grid=>mc_fc_refresh.
      APPEND ls_exclude TO gt_exclude.
      ls_exclude = cl_gui_alv_grid=>mc_fc_loc_delete_row.
      APPEND ls_exclude TO gt_exclude.
      ls_exclude = cl_gui_alv_grid=>mc_fc_loc_insert_row.
      APPEND ls_exclude TO gt_exclude.
      ls_exclude = cl_gui_alv_grid=>mc_fc_loc_copy_row.
      APPEND ls_exclude TO gt_exclude.
      ls_exclude = cl_gui_alv_grid=>mc_fc_loc_cut.
      APPEND ls_exclude TO gt_exclude.
      ls_exclude = cl_gui_alv_grid=>mc_fc_loc_undo.
      APPEND ls_exclude TO gt_exclude.
      ls_exclude = cl_gui_alv_grid=>mc_fc_loc_paste.
      APPEND ls_exclude TO gt_exclude.
      ls_exclude = cl_gui_alv_grid=>mc_fc_loc_paste_new_row.
      APPEND ls_exclude TO gt_exclude.
      ls_exclude = cl_gui_alv_grid=>mc_fc_loc_append_row.
      APPEND ls_exclude TO gt_exclude.
      ls_exclude = cl_gui_alv_grid=>mc_fc_loc_copy.
      APPEND ls_exclude TO gt_exclude.

      ls_layout-stylefname = 'CELLSTYLES'.
      ls_layout-sel_mode   = 'A'.
      ls_layout-zebra      = 'X'.
      ls_layout-cwidth_opt = 'X'.
      gs_variant-report    = sy-repid.
      gs_variant-username  = sy-uname.

      " Nastaven√≠ t≈ô√≠dƒõn√≠ podle pole DATUB vzestupnƒõ
      ls_sort-spos = 1.  " Priorita (1 = prvn√≠ sloupec pro t≈ô√≠dƒõn√≠)
      ls_sort-fieldname = 'SAP_ID'.  " N√°zev pole, podle kter√©ho se bude t≈ô√≠dit
      ls_sort-up = 'X'.  " 'X' pro vzestupn√© ≈ôazen√≠, ' ' pro sestupn√©
      APPEND ls_sort TO lt_sort.

      " üìå Zobrazen√≠ modul√°rn√≠ tabulky do ALV
      CALL METHOD mo_grid->set_table_for_first_display
        EXPORTING
          is_variant                    = gs_variant
          is_layout                     = ls_layout
          i_save                        = 'A'
          it_toolbar_excluding          = gt_exclude
        CHANGING
          it_sort                       = lt_sort
          it_fieldcatalog               = lt_fcat
          it_outtab                     = mt_data
        EXCEPTIONS
          invalid_parameter_combination = 1
          program_error                 = 2
          too_many_lines                = 3
          OTHERS                        = 4.

      IF sy-subrc EQ 0.

        SET HANDLER handle_toolbar                        FOR mo_grid.
        SET HANDLER handle_user_command                   FOR mo_grid.
        SET HANDLER handle_data_changed                   FOR mo_grid.

        CALL METHOD mo_grid->set_toolbar_interactive.

*        CALL METHOD mo_grid->register_edit_event
*          EXPORTING
*            i_event_id = cl_gui_alv_grid=>mc_evt_modified.

        CALL METHOD mo_grid->register_edit_event
          EXPORTING
            i_event_id = cl_gui_alv_grid=>mc_evt_enter.

        CALL METHOD mo_grid->set_focus
          EXPORTING
            control = mo_grid.
      ENDIF.
    ELSE.
      alv_refresh( ).
    ENDIF.
  ENDMETHOD.

  METHOD alv_refresh.

    DATA  ls_stable   TYPE lvc_s_stbl.

    ls_stable-row = 'X'.
    ls_stable-col = 'X'.

    CALL METHOD mo_grid->refresh_table_display
      EXPORTING
        is_stable = ls_stable.
  ENDMETHOD.

  METHOD alv_edit.


    DATA: ls_stylerow TYPE lvc_s_styl,                    " Styl pro ≈ô√°dek v ALV
          lr_listrow  TYPE REF TO ty_zpp_api_matrix_str.  " Reference na strukturu typu ty_zpp_api_matrix_str

*‚úèÔ∏è Zji≈°en√≠ platnosti certifik√°tu po refreshi
    LOOP AT mt_data REFERENCE INTO DATA(lr_data).

*‚úèÔ∏è Zji≈°en√≠ platnosti certifik√°tu
      lr_data->verify = COND #( WHEN lr_data->datub >= sy-datum
                                 AND lr_data->datuv <= sy-datum
                                 AND lr_data->datub > lr_data->datuv
                                 AND lr_data->datuv IS NOT INITIAL
                               THEN icon_green_light
                               ELSE icon_red_light ).

    ENDLOOP.

*‚úèÔ∏è Zaji≈°tƒõn√≠ editovatelnosti pr√°zdn√Ωch ≈ô√°dk≈Ø
    LOOP AT mt_data REFERENCE INTO lr_listrow.
      CLEAR lr_listrow->cellstyles.

      IF lr_listrow->sap_id IS INITIAL OR lr_listrow->werks IS INITIAL
OR lr_listrow->api_id IS INITIAL OR lr_listrow->charg IS INITIAL.

        lr_listrow->cellstyles = VALUE #(
            "Kl√≠ƒçov√° pole jsou editovateln√°, aby u≈æivatel editoval jen to, co je pot≈ôebn√©
            ( fieldname = 'SAP_ID' style = cl_gui_alv_grid=>mc_style_enabled )
            ( fieldname = 'WERKS' style = cl_gui_alv_grid=>mc_style_enabled )
            ( fieldname = 'CHARG' style = cl_gui_alv_grid=>mc_style_enabled )
            ( fieldname = 'API_ID' style = cl_gui_alv_grid=>mc_style_enabled )
            " Nekl√≠ƒçov√° pole jsou editovateln√°, by u≈æivatel editoval jen to, co je pot≈ôebn√©
            ( fieldname = 'API_NAME' style = cl_gui_alv_grid=>mc_style_disabled )
            ( fieldname = 'MAKTX' style = cl_gui_alv_grid=>mc_style_disabled )
            ( fieldname = 'DESTINATION' style = cl_gui_alv_grid=>mc_style_disabled )
            ( fieldname = 'INN_DEVICE' style = cl_gui_alv_grid=>mc_style_disabled )
            ( fieldname = 'MZP' style = cl_gui_alv_grid=>mc_style_disabled )
            ( fieldname = 'PRODUCTION_PLANT' style = cl_gui_alv_grid=>mc_style_disabled )
            ( fieldname = 'MZP_CSP' style = cl_gui_alv_grid=>mc_style_disabled )
            ( fieldname = 'MZP_BC' style = cl_gui_alv_grid=>mc_style_disabled )
            ( fieldname = 'DATUV_OLD' style = cl_gui_alv_grid=>mc_style_disabled )
            ( fieldname = 'DATUB_OLD' style = cl_gui_alv_grid=>mc_style_disabled )
            ( fieldname = 'VERIFY' style = cl_gui_alv_grid=>mc_style_disabled )
        ).

      ENDIF.

    ENDLOOP.

  ENDMETHOD.

  METHOD alv_edit_after_delete.

    DATA: lt_zpp_api_matrix TYPE TABLE OF zpp_api_matrix,  " Tabulka pro z√°znamy z zpp_api_matrix
          lt_data_delete    TYPE TABLE OF zpp_api_matrix.     " Tabulka pro z√°znamy urƒçen√© k odstranƒõn√≠

    " Naƒçten√≠ datab√°zov√© tabulky
    SELECT *
      FROM zpp_api_matrix
      INTO TABLE @lt_zpp_api_matrix.

    IF lt_zpp_api_matrix[] IS NOT INITIAL.
      LOOP AT mt_data REFERENCE INTO DATA(lr_data).
        IF NOT line_exists( lt_zpp_api_matrix[ sap_id = lr_data->sap_id
                                               werks  = lr_data->werks
                                               api_id = lr_data->api_id
                                               charg  = lr_data->charg ] ).
          CLEAR lr_data->sap_id.
        ENDIF.
      ENDLOOP.
      DELETE mt_data WHERE sap_id IS INITIAL.
    ENDIF.
  ENDMETHOD.

  METHOD handle_data_changed.



    DATA: lt_error  TYPE TABLE OF lvc_s_modi, " Tabulka pro chyby
          ls_modi   TYPE lvc_s_modi,          " Struktura pro jeden z√°znam o zmƒõnƒõ
          ls_error  TYPE lvc_s_modi,          " Struktura pro chybu
          lv_sap_id TYPE matnr,               " SAP ID pro materi√°l
          lv_werks  TYPE werks_d,             " K√≥d z√°vodu
          lv_api_id TYPE idnrk,               " API ID pro identifikaci
          lv_charg  TYPE charg_d,             " ƒå√≠slo ≈°ar≈æe
          lv_length TYPE i.                   " D√©lka promƒõnn√©



    LOOP AT er_data_changed->mt_good_cells INTO ls_modi.
      " Ovƒõ≈ô√≠me, zda se zmƒõnila hodnota z√°vodu (SAP_ID)
      IF ls_modi-fieldname = 'SAP_ID' AND ls_modi-value IS NOT INITIAL.
        lv_sap_id = ls_modi-value.
        SELECT SINGLE matnr
          FROM mara
          INTO @DATA(lv_mara)
          WHERE matnr = @lv_sap_id.

        IF sy-subrc <> 0.
          ls_error = ls_modi.
          APPEND ls_error TO lt_error.
          IF lt_error IS NOT INITIAL.
            LOOP AT lt_error INTO ls_modi.
              CALL METHOD er_data_changed->add_protocol_entry
                EXPORTING
                  i_msgid     = 'ZMSG'
                  i_msgty     = 'E'
                  i_msgno     = '001'
                  i_msgv1     = |Neplatn√© SAP_ID na ≈ô√°dku: { sy-tabix } |
                  i_fieldname = ls_modi-fieldname
                  i_row_id    = ls_modi-row_id.

            ENDLOOP.
            CLEAR: lt_error, ls_error.

            " Chybn√° hodnota => p≈ôid√°me do seznamu chyb
          ENDIF.
        ENDIF.
        " Ovƒõ≈ô√≠me, zda se zmƒõnila hodnota z√°vodu (WERKS)
      ELSEIF ls_modi-fieldname = 'WERKS' AND ls_modi-value IS NOT INITIAL.
        lv_werks = ls_modi-value.

        " Zkontrolujeme, zda z√°vod existuje v tabulce T001W
        SELECT SINGLE werks
          FROM t001w
          INTO @DATA(lv_dummy)
          WHERE werks = @lv_werks.
        IF sy-subrc <> 0.

          " Chybn√° hodnota => p≈ôid√°me do seznamu chyb
          ls_error = ls_modi.
          APPEND ls_error TO lt_error.

          IF lt_error IS NOT INITIAL.
            LOOP AT lt_error INTO ls_modi.
              CALL METHOD er_data_changed->add_protocol_entry
                EXPORTING
                  i_msgid     = 'ZMSG'
                  i_msgty     = 'E'
                  i_msgno     = '001'
                  i_msgv1     = 'Neplatn√Ω z√°vod'
                  i_fieldname = ls_modi-fieldname
                  i_row_id    = ls_modi-row_id.

            ENDLOOP.
            CLEAR: lt_error, ls_error.
          ENDIF.
        ENDIF.
      ELSEIF ls_modi-fieldname = 'API_ID' AND ls_modi-value IS NOT INITIAL.
        lv_api_id = ls_modi-value.
        SELECT SINGLE matnr
          FROM mara
          INTO @lv_mara
          WHERE matnr = @lv_api_id.

        IF sy-subrc <> 0.
          " Chybn√° hodnota => p≈ôid√°me do seznamu chyb
          ls_error = ls_modi.
          APPEND ls_error TO lt_error.

          IF lt_error IS NOT INITIAL.
            LOOP AT lt_error INTO ls_modi.
              CALL METHOD er_data_changed->add_protocol_entry
                EXPORTING
                  i_msgid     = 'ZMSG'
                  i_msgty     = 'E'
                  i_msgno     = '001'
                  i_msgv1     = 'Neplatn√© API_ID'
                  i_fieldname = ls_modi-fieldname
                  i_row_id    = ls_modi-row_id.

            ENDLOOP.
            CLEAR: lt_error, ls_error.
          ENDIF.
        ENDIF.

      ELSEIF ls_modi-fieldname = 'CHARG' AND ls_modi-value IS NOT INITIAL.

        lv_length = 10.
        lv_charg = ls_modi-value.
        IF strlen( lv_charg ) <> lv_length.

          " Chybn√° hodnota => p≈ôid√°me do seznamu chyb
          ls_error = ls_modi.
          APPEND ls_error TO lt_error.

          IF lt_error IS NOT INITIAL.
            LOOP AT lt_error INTO ls_modi.
              CALL METHOD er_data_changed->add_protocol_entry
                EXPORTING
                  i_msgid     = 'ZMSG'
                  i_msgty     = 'E'
                  i_msgno     = '001'
                  i_msgv1     = 'Neplatn√© CHARG'
                  i_fieldname = ls_modi-fieldname
                  i_row_id    = ls_modi-row_id.

            ENDLOOP.
            CLEAR: lt_error, ls_error.
          ENDIF.
        ENDIF.
      ENDIF.
    ENDLOOP.
  ENDMETHOD.

  METHOD handle_toolbar.

    DATA  ls_toolbar TYPE stb_button.

    CLEAR ls_toolbar.
    MOVE 3 TO ls_toolbar-butn_type.
    APPEND ls_toolbar               TO e_object->mt_toolbar.

    CLEAR ls_toolbar.

    ls_toolbar-function  = 'ADD_ROW'.
    ls_toolbar-icon      = icon_create.
    ls_toolbar-quickinfo = TEXT-000.
    ls_toolbar-text      = TEXT-000.
    APPEND ls_toolbar              TO e_object->mt_toolbar.

    ls_toolbar-function  = 'INSERT_ROW'.
    ls_toolbar-icon      = icon_edit_file.
    ls_toolbar-quickinfo = TEXT-002.
    ls_toolbar-text      = TEXT-002.
    APPEND ls_toolbar              TO e_object->mt_toolbar.


    ls_toolbar-function  = 'ADD'.
    ls_toolbar-icon      = icon_businav_process.
    ls_toolbar-quickinfo = TEXT-001.
    ls_toolbar-text      = TEXT-001.
    APPEND ls_toolbar              TO e_object->mt_toolbar.


    ls_toolbar-function  = 'DELETE'.
    ls_toolbar-icon      = icon_delete.
    ls_toolbar-quickinfo = TEXT-003.
    ls_toolbar-text      = TEXT-003.
    APPEND ls_toolbar              TO e_object->mt_toolbar.

    CLEAR ls_toolbar.

  ENDMETHOD.

  METHOD handle_user_command.

    DATA: row    TYPE lvc_t_row,
          lt_row TYPE lvc_t_row.

    CASE e_ucomm.
      WHEN  'ADD_ROW'.
        add_row( ).   " p≈ôidej ≈ô√°dek
        alv_edit( ).
        alv_refresh( ).

      WHEN 'INSERT_ROW'.
        insert_row( ).   " vlo≈æ ≈ô√°dek do datab√°ze
        alv_edit( ).
        alv_refresh( ).

      WHEN  'ADD'.
        update( ).   " ulo≈æ
        alv_edit( ).
        alv_refresh( ).

      WHEN 'DELETE'.
        delete( ).   " vyma≈æ
        alv_edit( ).
        alv_refresh( ).
    ENDCASE.

  ENDMETHOD.


ENDCLASS.                  "lcl_app IMPLEMENTATION

DATA go_inst TYPE REF TO lcl_app.

MODULE status_0100 OUTPUT.

  SET PF-STATUS 'STATUS_0100'.

  SET TITLEBAR '0102' .

  go_inst->alv_create( ).

ENDMODULE.                 " STATUS_0100  OUTPUT

MODULE user_command_0100 INPUT.
  CASE sy-ucomm.
    WHEN 'BACK' OR 'CANC' OR 'EXIT'.
      LEAVE TO SCREEN 0.
  ENDCASE.
ENDMODULE.                 " USER_COMMAND_0100  INPUT

INITIALIZATION.

  CLEAR gs_variant.
  gs_variant-report = sy-repid.

  CALL FUNCTION 'REUSE_ALV_VARIANT_DEFAULT_GET'
    EXPORTING
      i_save     = 'A'
    CHANGING
      cs_variant = gs_variant
    EXCEPTIONS
      not_found  = 2.

  IF sy-subrc = 0.
    p_varnt = gs_variant-variant.
  ENDIF.

AT SELECTION-SCREEN ON VALUE-REQUEST FOR p_varnt.

  DATA  lv_exit TYPE c.

  CALL FUNCTION 'REUSE_ALV_VARIANT_F4'
    EXPORTING
      is_variant = gs_variant
      i_save     = 'A'
    IMPORTING
      e_exit     = lv_exit
      es_variant = gs_variant
    EXCEPTIONS
      not_found  = 2.

  IF sy-subrc = 2.
    MESSAGE ID sy-msgid TYPE 'S' NUMBER sy-msgno
      WITH sy-msgv1 sy-msgv2 sy-msgv3 sy-msgv4.
  ELSE.
    IF lv_exit EQ space.
      p_varnt = gs_variant-variant.
    ENDIF.
  ENDIF.

START-OF-SELECTION.

* üöÄ
  CREATE OBJECT go_inst.
  go_inst->run( ).